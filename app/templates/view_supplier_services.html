{% import "toolkit/summary-table.html" as summary %}
{% import 'macros/answers.html' as answers %}

{% extends "_base_page.html" %}

{% block page_title %}
    {{ supplier.name }} â€“ Digital Marketplace admin
{% endblock %}

{% block breadcrumb %}
    {%
        with items = [
            {
                "link": url_for('.index'),
                "label": "Admin home"
            },
            {
                "label": supplier.name
            }
        ]
    %}
    {% include "_breadcrumb.html" %}
    {% endwith %}
{% endblock %}

{% block main_content %}
    {% with heading = "Services" %}
        {% include "toolkit/page-heading.html" %}
    {% endwith %}

    <h3>Assessed</h3>

    <div class='page-section'>
        {% call(sd) summary.list_table(
            supplier.domains.all,
            caption="Services",
            empty_message="This supplier has no services on the Digital Marketplace",
            field_headings=[
                'Service',
                'Status',
                'Price Status',
                'Actions'
            ],
            field_headings_visible=True)
        %}

        {% call summary.row() %}
            {% if sd.status == 'assessed' %}
                {{ summary.text(sd.domain_name) }}
                {{ summary.text(sd.status) }}
                {{ summary.text(sd.price_status) }}
                <td>
                    <span>
                        <form method="post">
                            {{ form.csrf_token }}
                            <button type="submit"
                                    class="button-secondary"
                                    formaction={{ url_for(".update_supplier_domain_price_status", supplier_code=supplier.code, supplier_domain_id=sd.id, price_status='approved') }}>Approve price</button>
                            <button type="submit"
                                    class="button-secondary"
                                    formaction={{ url_for(".update_supplier_domain_price_status", supplier_code=supplier.code, supplier_domain_id=sd.id, price_status='rejected') }}>Reject price</button>
                        </form>
                    </span>
                </td>
            {% endif %}
        {% endcall %}
        {% endcall %}
    </div>

    <h3>Unassessed</h3>

    <div class='page-section'>
        {% call(domain) summary.list_table(
            supplier.domains.unassessed,
            caption="Services to assess",
            empty_message="This supplier has no services to assess",
            field_headings=[
                'Service',
                'Brief ID',
                'Action'
            ],
            field_headings_visible=True)
        %}

        {% call summary.row() %}
            {{ summary.field_name(domain) }}

            {% set form_suffix = domain.replace(' ', '_').replace(',', '_') %}
            {% set form_suffix = form_suffix.lower() %}

            {% call summary.field() %}
                <input form="assess_domain_{{ form_suffix }}" name="brief_id" type="number" autofocus />    
            {% endcall %}        
            
            {% call summary.field() %}
            <form id="assess_domain_{{ form_suffix }}" action="{{ url_for('.trigger_assessment') }}" method="post">
                {{ form.csrf_token }}
                {%
                    with
                    label = "Assess"
                %}
                {% include "toolkit/button.html" %}
                {% endwith %}

                <input name="domain_name" type="hidden" value="{{ domain }}" />
                <input name="supplier_code" type="hidden" value="{{ supplier.code }}" />
            </form>
            {% endcall %}
        {% endcall %}
        {% endcall %}
    </div>
{% endblock %}
